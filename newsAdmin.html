<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | News</title>
    <style>
        :root { --primary-turquoise:#20B2AA; --dark-turquoise:#008B8B; --light-turquoise:#E0FFFF; --soft-turquoise:#B0E0E6; --pale-turquoise:#F0FFFF; --medium-turquoise:#48CAE4; --deep-turquoise:#007F7F; --white:#FFFFFF; --light-gray:#F8F9FA; --medium-gray:#E9ECEF; --text-gray:#495057; --dark-gray:#212529; --header-bg:linear-gradient(135deg, var(--pale-turquoise) 0%, var(--light-turquoise) 50%, var(--soft-turquoise) 100%); }
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Arial',sans-serif}
        body{background:linear-gradient(180deg,var(--pale-turquoise) 0%,var(--light-turquoise) 100%);color:var(--text-gray);min-height:100vh}
        header{display:flex;align-items:center;justify-content:space-between;padding:15px 20px;background:var(--header-bg)}
        .nav-section{display:flex;gap:12px}
        .nav-item{font-weight:600;cursor:pointer;color:var(--dark-turquoise);transition:all 0.4s ease;text-transform:uppercase;font-size:0.85em;letter-spacing:1.2px;padding:10px 18px;text-decoration:none;border-radius:8px;background:var(--white);box-shadow:0 2px 8px rgba(32,178,170,0.2);border:2px solid var(--primary-turquoise)}
        .nav-item:hover{color:var(--white);background:linear-gradient(135deg,var(--primary-turquoise) 0%,var(--dark-turquoise) 100%);transform:translateY(-3px);box-shadow:0 6px 20px rgba(32,178,170,0.4);border-color:var(--dark-turquoise)}
        .nav-item.active{background:linear-gradient(135deg,var(--primary-turquoise) 0%,var(--dark-turquoise) 100%);color:var(--white);box-shadow:0 4px 12px rgba(32,178,170,0.3)}
        .container{max-width:1000px;margin:24px auto;padding:0 16px}
        h1{color:var(--dark-turquoise);margin-bottom:12px}
        .card{background:var(--white);border:1px solid var(--medium-gray);border-radius:10px;box-shadow:0 3px 18px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
        .form-row{display:flex;gap:12px;flex-wrap:wrap}
        label{font-weight:bold;color:var(--dark-turquoise);display:block;margin-bottom:6px}
        input,textarea{width:100%;padding:10px;border:2px solid var(--medium-gray);border-radius:6px}
        textarea{min-height:100px}
        .btn{padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:700}
        .btn-primary{background:linear-gradient(135deg,var(--primary-turquoise) 0%,var(--dark-turquoise) 100%);color:#fff}
        .btn-secondary{background:linear-gradient(135deg,#dfe3e6 0%,#cbd0d6 100%);color:#222}
        .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
        .list{display:flex;flex-direction:column;gap:12px}
        .item{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;border:1px solid var(--medium-gray);border-radius:8px;padding:10px}
        .item-title{font-weight:700;color:var(--dark-turquoise)}
        .item-meta{font-size:.85em;opacity:.85}

        /* Custom Message System */
        .custom-message {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInRight 0.4s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .custom-message.success {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.95) 0%, rgba(34, 153, 84, 0.95) 100%);
            color: var(--white);
            border-color: rgba(39, 174, 96, 0.3);
        }

        .custom-message.error {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%);
            color: var(--white);
            border-color: rgba(231, 76, 60, 0.3);
        }

        .custom-message.warning {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.95) 0%, rgba(230, 126, 34, 0.95) 100%);
            color: var(--white);
            border-color: rgba(243, 156, 18, 0.3);
        }

        .custom-message.info {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.95) 0%, rgba(41, 128, 185, 0.95) 100%);
            color: var(--white);
            border-color: rgba(52, 152, 219, 0.3);
        }

        .message-icon {
            font-size: 1.4em;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .message-content {
            flex: 1;
        }

        .message-title {
            font-weight: 700;
            font-size: 1em;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message-text {
            font-size: 0.9em;
            opacity: 0.95;
            line-height: 1.4;
        }

        .message-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.2em;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .message-close:hover {
            opacity: 1;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* Custom Confirmation Dialog Styles */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .confirm-dialog {
            background: linear-gradient(135deg, var(--white) 0%, var(--pale-turquoise) 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .confirm-dialog::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-turquoise) 0%, var(--medium-turquoise) 100%);
        }

        .confirm-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .confirm-icon {
            font-size: 2.5em;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .confirm-title {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--dark-turquoise);
            margin: 0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .confirm-message {
            font-size: 1em;
            color: var(--text-gray);
            line-height: 1.5;
            margin-bottom: 25px;
            padding-left: 10px;
        }

        .confirm-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .confirm-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .confirm-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .confirm-btn:hover::before {
            left: 100%;
        }

        .confirm-btn.danger {
            background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .confirm-btn.danger:hover {
            background: linear-gradient(135deg, #C0392B 0%, #A93226 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .confirm-btn.secondary {
            background: linear-gradient(135deg, var(--medium-gray) 0%, #D0D4D9 100%);
            color: var(--dark-gray);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .confirm-btn.secondary:hover {
            background: linear-gradient(135deg, var(--text-gray) 0%, #495057 100%);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 767px) {
            header { padding: 12px 14px; }
            .logo-graphic { transform: scale(0.85); transform-origin: left center; }
            .nav-item { font-size: 0.75em; padding: 6px 10px; }
            .container { margin: 16px auto; padding: 0 12px; }
            .card { padding: 14px; }
            .form-row { gap: 8px; }
            .actions { flex-direction: column; align-items: stretch; }
            .list { gap: 10px; }
            .item { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <header>
        <div style="font-weight:800;color:var(--dark-turquoise)">News Admin</div>
        <div class="nav-section">
            <a href="home.html" class="nav-item">Home</a>
            <a href="casas.html" class="nav-item">Properties</a>
            <a href="news.html" class="nav-item">News</a>
            <a href="Contact.html" class="nav-item">Contact</a>
            <a href="casasAdmin.html" class="nav-item">Casas Admin</a>
        </div>
    </header>

    <div class="container">
        <div class="card" style="display:flex;align-items:center;justify-content:space-between">
            <div style="font-weight:700;color:var(--dark-turquoise)">Atajos</div>
            <div>
                <a href="casasAdmin.html" class="btn btn-primary" title="Ir a Properties Admin">Ir a Casas Admin</a>
            </div>
        </div>
        <div class="card">
            <h1>Crear/Editar noticia</h1>
            <div class="form-row">
                <div style="flex:1 1 320px">
                    <label for="newsTitle">Título</label>
                    <input id="newsTitle" placeholder="Título de la noticia">
                </div>
                <div style="flex:1 1 320px">
                    <label for="newsLink">Enlace (opcional)</label>
                    <input id="newsLink" placeholder="https://...">
                    <div id="linkPreview" style="margin-top:8px;display:none">
                        <img id="linkPreviewImg" alt="preview" style="max-width:100%;max-height:160px;border:1px solid var(--medium-gray);border-radius:6px;">
                    </div>
                </div>
            </div>
            <div class="form-row" style="margin-top:10px">
                <div style="flex:1 1 100%">
                    <label for="newsDesc">Descripción</label>
                    <textarea id="newsDesc" placeholder="Texto de la noticia (admite saltos de línea)"></textarea>
                </div>
            </div>
            <div class="actions">
                <button class="btn btn-secondary" id="clearForm">Limpiar</button>
                <button class="btn btn-primary" id="saveNews">Guardar</button>
            </div>
        </div>

        <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between">
                <h2 style="color:var(--dark-turquoise);margin:0">Noticias</h2>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-secondary" id="exportBtn">Exportar</button>
                    <button class="btn btn-secondary" id="importBtn">Importar</button>
                    <input type="file" id="importFile" accept="application/json" style="display:none">
                </div>
            </div>
            <div id="newsList" class="list" style="margin-top:12px"></div>
        </div>
    </div>

    <script>
        const KEY = 'mbi_news_items';
        const NEWS_API = 'https://93.189.91.62:8443/news';
        let editingIndex = null;

        function loadNews(){ try{ const raw=localStorage.getItem(KEY); const arr = raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr:[]; }catch(_){ return []; } }
        function saveNewsArray(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
        async function fetchAll(){ try{ const r=await fetch(NEWS_API); if(!r.ok) throw 0; const d=await r.json(); if(Array.isArray(d)){ saveNewsArray(d); return d; } }catch(_){ } return loadNews(); }
        async function createNews(obj){ try{ const r=await fetch(NEWS_API,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(obj)}); if(!r.ok) throw 0; const d=await r.json(); const arr=loadNews(); arr.unshift(d); saveNewsArray(arr); return d; }catch(_){ const arr=loadNews(); arr.unshift(obj); saveNewsArray(arr); return obj; } }
        async function updateNewsAt(index,obj){ const items=loadNews(); const id=items[index]&&items[index].id; try{ const r=await fetch(`${NEWS_API}/${id}`,{method:'PUT',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(obj)}); if(!r.ok) throw 0; const d=await r.json(); items[index]=d; saveNewsArray(items); return d; }catch(_){ items[index]=Object.assign({id},obj); saveNewsArray(items); return items[index]; } }
        async function deleteNewsAt(index){ const items=loadNews(); const id=items[index]&&items[index].id; try{ const r=await fetch(`${NEWS_API}/${id}`,{method:'DELETE'}); if(!r.ok) throw 0; items.splice(index,1); saveNewsArray(items); }catch(_){ items.splice(index,1); saveNewsArray(items); } }

        function clearForm(){ document.getElementById('newsTitle').value=''; document.getElementById('newsLink').value=''; document.getElementById('newsDesc').value=''; editingIndex=null; }

        async function renderList(){
            const container = document.getElementById('newsList');
            container.innerHTML='';
            const items = await fetchAll();
            if(!items.length){ container.innerHTML = '<div style="text-align:center;color:#666;padding:16px">Sin noticias</div>'; return; }
            items.forEach((item, idx)=>{
                const el = document.createElement('div');
                el.className='item';
                const dateStr = item.date ? new Date(item.date).toLocaleString() : '';
                el.innerHTML = `
                    <div style="flex:1 1 auto">
                        <div class="item-title">${item.title||'Untitled'}</div>
                        <div class="item-meta">${dateStr}</div>
                        ${item.description?`<div style="margin-top:6px">${(item.description||'').replace(/\n/g,'<br>')}</div>`:''}
                        ${item.link?`<div style="margin-top:6px"><a href="${item.link}" target="_blank" rel="noopener">${item.link}</a></div>`:''}
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-secondary" data-action="edit">Editar</button>
                        <button class="btn btn-secondary" data-action="delete">Eliminar</button>
                    </div>`;
                el.querySelector('[data-action="edit"]').addEventListener('click', ()=>{
                    const items = loadNews();
                    const it = items[idx];
                    document.getElementById('newsTitle').value = it.title||'';
                    document.getElementById('newsLink').value = it.link||'';
                    document.getElementById('newsDesc').value = it.description||'';
                    editingIndex = idx;
                });
                el.querySelector('[data-action="delete"]').addEventListener('click', async ()=>{
                    const confirmed = await showConfirm(
                        'Eliminar noticia', 
                        `¿Estás seguro de que quieres eliminar la noticia "${item.title || 'Sin título'}"? Esta acción no se puede deshacer.`,
                        '🗑️',
                        'Eliminar',
                        'Cancelar'
                    );
                    
                    if (confirmed) {
                        try {
                            await deleteNewsAt(idx);
                            showSuccess('Noticia eliminada', 'La noticia se ha eliminado correctamente de la base de datos');
                            renderList();
                        } catch (error) {
                            console.error('Error deleting news:', error);
                            showError('Error al eliminar', 'No se pudo eliminar la noticia. Inténtalo de nuevo.');
                        }
                    }
                });
                container.appendChild(el);
            });
        }

        async function fetchLinkMetadata(url){
            try{
                const endpoint = 'https://api.microlink.io/?url=' + encodeURIComponent(url);
                const res = await fetch(endpoint);
                if(!res.ok) throw new Error('HTTP '+res.status);
                const json = await res.json();
                if(!json || !json.status || !json.data) throw new Error('Respuesta inválida');
                const d = json.data;
                return {
                    title: d.title || '',
                    description: d.description || '',
                    image: d.image && (d.image.url || d.image) ? (d.image.url || d.image) : '',
                    url: d.url || url
                };
            }catch(err){
                console.error('Metadata fetch error:', err);
                return null;
            }
        }

        const linkInput = document.getElementById('newsLink');
        linkInput.addEventListener('blur', async ()=>{
            const url = linkInput.value.trim();
            if(!url) return;
            const meta = await fetchLinkMetadata(url);
            if(meta){
                const titleEl = document.getElementById('newsTitle');
                const descEl = document.getElementById('newsDesc');
                if(!titleEl.value.trim() && meta.title) titleEl.value = meta.title;
                if(!descEl.value.trim() && meta.description) descEl.value = meta.description;
                linkInput.value = meta.url || url;
                linkInput.dataset.image = meta.image || '';
                const prevWrap = document.getElementById('linkPreview');
                const prevImg = document.getElementById('linkPreviewImg');
                if(meta.image){ prevImg.src = meta.image; prevWrap.style.display = 'block'; } else { prevImg.removeAttribute('src'); prevWrap.style.display = 'none'; }
            }
        });

        document.getElementById('saveNews').addEventListener('click', async ()=>{
            const title = document.getElementById('newsTitle').value.trim();
            const link = document.getElementById('newsLink').value.trim();
            const description = document.getElementById('newsDesc').value.trim();
            if(!title && !description && !link){ 
                showError('Error de validación', 'Debe completar al menos el título o la descripción');
                return; 
            }
            
            try {
                // asegúrate de tener metadata si solo hay link
                let image = linkInput.dataset.image || '';
                if(link && (!title || !description || !image)){
                    const meta = await fetchLinkMetadata(link);
                    if(meta){
                        if(!title) document.getElementById('newsTitle').value = meta.title || '';
                        if(!description) document.getElementById('newsDesc').value = meta.description || '';
                        if(!image) image = meta.image || '';
                    }
                }
                const obj = { title: document.getElementById('newsTitle').value.trim(), link, description: document.getElementById('newsDesc').value.trim(), image, date: Date.now() };
                
                if(editingIndex!==null){ 
                    await updateNewsAt(editingIndex,obj); 
                    showSuccess('Noticia actualizada', 'La noticia se ha actualizado correctamente en la base de datos');
                } else { 
                    await createNews(obj); 
                    showSuccess('Noticia creada', 'La noticia se ha guardado correctamente en la base de datos');
                }
                clearForm(); 
                renderList();
            } catch (error) {
                console.error('Error saving news:', error);
                showError('Error al guardar', 'No se pudo guardar la noticia. Inténtalo de nuevo.');
            }
        });

        document.getElementById('clearForm').addEventListener('click', clearForm);

        document.getElementById('exportBtn').addEventListener('click', ()=>{
            const dataStr = JSON.stringify(loadNews(), null, 2);
            const blob = new Blob([dataStr], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'news-backup.json'; a.click(); URL.revokeObjectURL(url);
        });

        document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
        document.getElementById('importFile').addEventListener('change', (e)=>{
            const file = e.target.files && e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev)=>{ try{ const arr = JSON.parse(ev.target.result); if(Array.isArray(arr)){ saveNewsArray(arr); renderList(); } }catch(_){} };
            reader.readAsText(file);
            e.target.value='';
        });

        // Custom Message System
        function showMessage(type, title, message, duration = 5000, customIcon = null) {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.custom-message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageEl = document.createElement('div');
            messageEl.className = `custom-message ${type}`;
            
            // Define icons for different message types
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️',
                // Specific action icons
                create: '📝',
                update: '✏️',
                delete: '🗑️',
                save: '💾',
                load: '📥',
                export: '📤',
                import: '📥'
            };
            
            const icon = customIcon || icons[type] || icons.info;
            
            messageEl.innerHTML = `
                <div class="message-icon">${icon}</div>
                <div class="message-content">
                    <div class="message-title">${title}</div>
                    <div class="message-text">${message}</div>
                </div>
                <button class="message-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            document.body.appendChild(messageEl);
            
            // Auto remove after duration
            setTimeout(() => {
                if (messageEl.parentElement) {
                    messageEl.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => messageEl.remove(), 300);
                }
            }, duration);
            
            return messageEl;
        }
        
        // Convenience functions for different message types
        function showSuccess(title, message, duration = 5000, customIcon = null) {
            return showMessage('success', title, message, duration, customIcon);
        }
        
        function showError(title, message, duration = 7000, customIcon = null) {
            return showMessage('error', title, message, duration, customIcon);
        }
        
        function showWarning(title, message, duration = 6000, customIcon = null) {
            return showMessage('warning', title, message, duration, customIcon);
        }
        
        function showInfo(title, message, duration = 5000, customIcon = null) {
            return showMessage('info', title, message, duration, customIcon);
        }

        // Custom Confirmation System
        function showConfirm(title, message, icon = '❓', confirmText = 'Confirmar', cancelText = 'Cancelar') {
            return new Promise((resolve) => {
                // Create overlay
                const overlay = document.createElement('div');
                overlay.className = 'confirm-overlay';
                
                // Create dialog
                const dialog = document.createElement('div');
                dialog.className = 'confirm-dialog';
                
                dialog.innerHTML = `
                    <div class="confirm-header">
                        <div class="confirm-icon">${icon}</div>
                        <h3 class="confirm-title">${title}</h3>
                    </div>
                    <div class="confirm-message">${message}</div>
                    <div class="confirm-actions">
                        <button class="confirm-btn secondary" data-action="cancel">${cancelText}</button>
                        <button class="confirm-btn danger" data-action="confirm">${confirmText}</button>
                    </div>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // Handle button clicks
                const buttons = dialog.querySelectorAll('.confirm-btn');
                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        const action = button.getAttribute('data-action');
                        const result = action === 'confirm';
                        
                        // Animate out
                        overlay.style.animation = 'fadeIn 0.2s ease reverse';
                        setTimeout(() => {
                            overlay.remove();
                        }, 200);
                        
                        resolve(result);
                    });
                });
                
                // Handle overlay click (cancel)
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.style.animation = 'fadeIn 0.2s ease reverse';
                        setTimeout(() => {
                            overlay.remove();
                        }, 200);
                        resolve(false);
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', renderList);
    </script>
</body>
</html>


