<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; font-src * data:; img-src * data: blob:; connect-src * http://93.189.91.62:8080 https://93.189.91.62:8443 https://93.189.91.62 https://93.189.91.62:443; frame-src *; object-src 'none';">
    <title>Admin | News</title>
    <style>
        :root { --primary-turquoise:#20B2AA; --dark-turquoise:#008B8B; --light-turquoise:#E0FFFF; --soft-turquoise:#B0E0E6; --pale-turquoise:#F0FFFF; --medium-turquoise:#48CAE4; --deep-turquoise:#007F7F; --white:#FFFFFF; --light-gray:#F8F9FA; --medium-gray:#E9ECEF; --text-gray:#495057; --dark-gray:#212529; --header-bg:linear-gradient(135deg, var(--pale-turquoise) 0%, var(--light-turquoise) 50%, var(--soft-turquoise) 100%); }
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Arial',sans-serif}
        body{background:linear-gradient(180deg,var(--pale-turquoise) 0%,var(--light-turquoise) 100%);color:var(--text-gray);min-height:100vh}
        header {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: #fff !important; /* fondo blanco */
            box-shadow: none;
            border-bottom: none;
            position: relative;
            z-index: 100;
            max-height: 230px; /* Altura para logo de 200px + padding */
            overflow: hidden;
        }
        
        .header-content {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: none;
        }
        
        .logo-section { display:flex; flex-direction:column; align-items:flex-start; justify-content:center; margin-bottom:0; width:auto; height:200px; overflow:visible; }
        .logo-section img { max-height:200px; height:auto; width:auto; display:block; object-fit:contain; }
        
        .nav-section{display:flex;gap:12px;align-items:center}
        /* Home2 header logo styles */
        .logo-graphic{position:relative;width:100%;max-width:400px;height:160px;background:transparent;display:flex;align-items:flex-start;justify-content:flex-start;padding:10px;overflow:visible}
        .semicircle{position:absolute;bottom:60px;left:0;width:100px;height:100px;border:4px solid #1e3a8a;border-radius:50%;background:transparent;z-index:20}
        .horizon-line{position:absolute;bottom:60px;left:0;width:100%;height:2px;background-color:#1e3a8a;border-top-left-radius:100px;border-top-right-radius:100px;z-index:20}
        .semicircle-underline{position:absolute;bottom:50px;left:8px;width:85px;height:2px;background-color:#1e3a8a;border-radius:4px;z-index:20}
        .logo-text{position:absolute;z-index:5;top:120px;left:0;display:flex;flex-direction:column;align-items:flex-start;text-align:left;white-space:nowrap;height:auto;pointer-events:none}
        .logo-main{font-size:1.1em;font-weight:700;color:#7dd3fc;letter-spacing:-0.5px;line-height:1.2}
        .logo-sub{display:block;font-weight:800;color:#7dd3fc;margin-top:2px;text-align:center}
        .nav-item{font-weight:600;cursor:pointer;color:var(--dark-turquoise);transition:all 0.4s ease;text-transform:uppercase;font-size:0.85em;letter-spacing:1.2px;padding:10px 18px;text-decoration:none;border-radius:8px;background:var(--white);box-shadow:0 2px 8px rgba(32,178,170,0.2);border:2px solid var(--primary-turquoise)}
        .nav-item:hover{color:var(--white);background:linear-gradient(135deg,var(--primary-turquoise) 0%,var(--dark-turquoise) 100%);transform:translateY(-3px);box-shadow:0 6px 20px rgba(32,178,170,0.4);border-color:var(--dark-turquoise)}
        .nav-item.active{background:linear-gradient(135deg,var(--primary-turquoise) 0%,var(--dark-turquoise) 100%);color:var(--white);box-shadow:0 4px 12px rgba(32,178,170,0.3)}
        .container{max-width:1000px;margin:10px auto;padding:0 16px}
        h1{color:var(--dark-turquoise);margin-bottom:12px}
        .card{background:var(--white);border:1px solid var(--medium-gray);border-radius:10px;box-shadow:0 3px 18px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
        .form-row{display:flex;gap:12px;flex-wrap:wrap}
        label{font-weight:bold;color:var(--dark-turquoise);display:block;margin-bottom:6px}
        input,textarea{width:100%;padding:10px;border:2px solid var(--medium-gray);border-radius:6px}
        textarea{min-height:100px}
        .btn{padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:700}
        .btn-primary{background:linear-gradient(135deg,var(--primary-turquoise) 0%,var(--dark-turquoise) 100%);color:#fff}
        .btn-secondary{background:linear-gradient(135deg,#dfe3e6 0%,#cbd0d6 100%);color:#222}
        .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
        .list{display:flex;flex-direction:column;gap:12px}
        .item{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;border:1px solid var(--medium-gray);border-radius:8px;padding:10px}
        .item-title{font-weight:700;color:var(--dark-turquoise)}
        .item-meta{font-size:.85em;opacity:.85}

        /* Custom Message System */
        .custom-message {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInRight 0.4s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .custom-message.success {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.95) 0%, rgba(34, 153, 84, 0.95) 100%);
            color: var(--white);
            border-color: rgba(39, 174, 96, 0.3);
        }

        .custom-message.error {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%);
            color: var(--white);
            border-color: rgba(231, 76, 60, 0.3);
        }

        .custom-message.warning {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.95) 0%, rgba(230, 126, 34, 0.95) 100%);
            color: var(--white);
            border-color: rgba(243, 156, 18, 0.3);
        }

        .custom-message.info {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.95) 0%, rgba(41, 128, 185, 0.95) 100%);
            color: var(--white);
            border-color: rgba(52, 152, 219, 0.3);
        }

        .message-icon {
            font-size: 1.4em;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .message-content {
            flex: 1;
        }

        .message-title {
            font-weight: 700;
            font-size: 1em;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message-text {
            font-size: 0.9em;
            opacity: 0.95;
            line-height: 1.4;
        }

        .message-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.2em;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .message-close:hover {
            opacity: 1;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* Custom Confirmation Dialog Styles */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .confirm-dialog {
            background: linear-gradient(135deg, var(--white) 0%, var(--pale-turquoise) 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .confirm-dialog::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-turquoise) 0%, var(--medium-turquoise) 100%);
        }

        .confirm-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .confirm-icon {
            font-size: 2.5em;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .confirm-title {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--dark-turquoise);
            margin: 0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .confirm-message {
            font-size: 1em;
            color: var(--text-gray);
            line-height: 1.5;
            margin-bottom: 25px;
            padding-left: 10px;
        }

        .confirm-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .confirm-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .confirm-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .confirm-btn:hover::before {
            left: 100%;
        }

        .confirm-btn.danger {
            background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .confirm-btn.danger:hover {
            background: linear-gradient(135deg, #C0392B 0%, #A93226 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .confirm-btn.secondary {
            background: linear-gradient(135deg, var(--medium-gray) 0%, #D0D4D9 100%);
            color: var(--dark-gray);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .confirm-btn.secondary:hover {
            background: linear-gradient(135deg, var(--text-gray) 0%, #495057 100%);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 767px) {
            header { padding: 12px 14px; max-height: 230px; overflow: hidden; }
            .logo-section { height: 200px; overflow: visible; }
            .logo-section img { max-height: 240px; width: auto; height: auto; }
            .logo-graphic { transform: scale(0.85); transform-origin: left center; }
            .nav-item { font-size: 0.75em; padding: 6px 10px; }
            .container { margin: 10px auto; padding: 0 12px; }
            .card { padding: 14px; }
            .form-row { gap: 8px; }
            .actions { flex-direction: column; align-items: stretch; }
            .list { gap: 10px; }
            .item { flex-direction: column; }
            .btn { width: 100%; }
            .horizon-line{width:240px}
            .logo-text{white-space:normal}
            .logo-main .logo-chunk{ display:block; text-align:left; }
            .logo-main .logo-chunk:last-child{ text-align:center; }
        }
        
        /* M√≥vil en horizontal - reducir botones de navegaci√≥n (pesta√±as) un 10% */
        @media (max-width: 1024px) and (orientation: landscape) {
            .nav-item {
                padding: 9px 16.2px !important;
                font-size: 0.765em !important;
                letter-spacing: 1.08px !important;
                border-radius: 7.2px !important;
            }
            
            .nav-section {
                gap: 13.5px !important;
                padding: 9px 13.5px !important;
                flex-wrap: nowrap !important;
                align-items: center !important;
                justify-content: flex-start !important;
            }
            
            /* Asegurar que el selector de idiomas est√© alineado */
            .lang-selector {
                margin-left: auto !important;
                align-self: center !important;
            }
            
            .lang-btn {
                display: inline-flex !important;
                align-items: center !important;
                box-shadow: none !important;
                border: none !important;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content" style="display:flex;align-items:center;gap:16px;width:100%">
            <div class="logo-section">
                <img src="logopos.jpg" alt="Mediterranean Blue International LLC Realty"/>
            </div>
            <div class="nav-section" style="margin-left:auto">
                <a href="home.html" class="nav-item">Home</a>
                <a href="casas.html" class="nav-item">Properties</a>
                <a href="news.html" class="nav-item">News</a>
                <a href="Contact.html" class="nav-item">Contact</a>
                <a href="casasAdmin.html" class="nav-item">Casas Admin</a>
                <a href="newsAdmin.html" class="nav-item active">News Admin</a>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="card" style="display:flex;align-items:center;justify-content:space-between">
            <div style="font-weight:700;color:var(--dark-turquoise)">Atajos</div>
            <div>
                <a href="casasAdmin.html" class="btn btn-primary" title="Ir a Properties Admin">Ir a Casas Admin</a>
            </div>
        </div>
        <div class="card">
            <h1>Crear/Editar noticia</h1>
            <div class="form-row">
                <div style="flex:1 1 320px">
                    <label for="newsTitle">T√≠tulo</label>
                    <input id="newsTitle" placeholder="T√≠tulo de la noticia">
                </div>
                <div style="flex:1 1 320px">
                    <label for="newsLink">Enlace (opcional)</label>
                    <input id="newsLink" placeholder="https://...">
                    <div id="linkPreview" style="margin-top:8px;display:none">
                        <img id="linkPreviewImg" alt="preview" style="max-width:100%;max-height:160px;border:1px solid var(--medium-gray);border-radius:6px;">
                    </div>
                </div>
            </div>
            <div class="form-row" style="margin-top:10px">
                <div style="flex:1 1 100%">
                    <label for="newsDesc">Descripci√≥n</label>
                    <textarea id="newsDesc" placeholder="Texto de la noticia (admite saltos de l√≠nea)"></textarea>
                </div>
            </div>
            <div class="form-row" style="margin-top:10px">
                <div style="flex:1 1 100%">
                    <label>Imagen</label>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <button type="button" class="btn btn-secondary" id="selectImageBtn">Seleccionar imagen</button>
                        <input type="file" id="newsImageFile" accept="image/*" style="display:none">
                        <div id="imagePreview" style="display:none;margin-top:8px">
                            <img id="imagePreviewImg" alt="Preview" style="max-width:200px;max-height:160px;border:1px solid var(--medium-gray);border-radius:6px;object-fit:cover;">
                            <button type="button" class="btn btn-secondary" id="removeImageBtn" style="margin-left:8px;padding:4px 8px;font-size:0.85em">Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="actions">
                <button class="btn btn-secondary" id="clearForm">Limpiar</button>
                <button class="btn btn-primary" id="saveNews">Guardar</button>
            </div>
        </div>

        <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between">
                <h2 style="color:var(--dark-turquoise);margin:0">Noticias</h2>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-secondary" id="exportBtn">Exportar</button>
                    <button class="btn btn-secondary" id="importBtn">Importar</button>
                    <input type="file" id="importFile" accept="application/json" style="display:none">
                </div>
            </div>
            <div id="newsList" class="list" style="margin-top:12px"></div>
        </div>
    </div>

    <script>
        const KEY = 'mbi_news_items';
        let editingIndex = null;
        let uploadedImageUrl = null; // URL de la imagen subida manualmente
        
        // Cloudinary Config
        const CLOUDINARY_CLOUD_NAME = 'dy2mavovq';
        const CLOUDINARY_UPLOAD_PRESET = 'unsigned_preset';
        const CLOUDINARY_FOLDER = 'news';
        
        async function uploadImageToCloudinary(file, folder = CLOUDINARY_FOLDER) {
            if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
                throw new Error('Falta configuraci√≥n de Cloudinary (cloud_name o upload_preset)');
            }
            const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            if (folder) { formData.append('folder', folder); }
            const response = await fetch(url, { method: 'POST', body: formData });
            if (!response.ok) {
                let detail = '';
                try {
                    const dataErr = await response.json();
                    detail = (dataErr && dataErr.error && dataErr.error.message) ? dataErr.error.message : JSON.stringify(dataErr);
                } catch (_) {
                    detail = await response.text().catch(() => '');
                }
                throw new Error(`Error Cloudinary ${response.status}: ${detail}`);
            }
            const data = await response.json();
            if (!data.secure_url) {
                throw new Error('Respuesta de Cloudinary inv√°lida (sin secure_url)');
            }
            return data.secure_url;
        }

        function loadNews(){ try{ const raw=localStorage.getItem(KEY); const arr = raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr:[]; }catch(_){ return []; } }
        function saveNewsArray(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
        
        // Funci√≥n para probar m√∫ltiples URLs
        async function tryFetch(url, options = {}) {
            try {
                // Agregar mode: 'cors' para evitar problemas de CORS
                const fetchOptions = {
                    ...options,
                    mode: 'cors',
                    credentials: 'omit'
                };
                const response = await fetch(url, fetchOptions);
                if (response.ok) {
                    return response;
                }
                throw new Error(`HTTP ${response.status}`);
            } catch (error) {
                // Si es un error de CSP, intentar con una petici√≥n m√°s permisiva
                if (error.message && error.message.includes('Content Security Policy')) {
                    console.error('CSP Error:', error);
                    throw new Error('CSP bloqueado: ' + error.message);
                }
                throw error;
            }
        }
        
        async function fetchAll(){ 
            const urls = [
                'https://mediterraneanbi.com:443/news',
                'https://mediterraneanbi.com:3000/news',
                'http://93.189.91.62:8080/news',
                'https://93.189.91.62:8443/news',
                'https://93.189.91.62/news',
            ];
            
            for (const url of urls) {
                try {
                    console.log('üîÑ Probando:', url);
                    const r = await tryFetch(url);
                    const d = await r.json();
                    if (Array.isArray(d)) {
                        saveNewsArray(d);
                        return d;
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è URL fall√≥:', url, e.message);
                }
            }
            return loadNews();
        }
        
        async function createNews(obj){ 
            const urls = [
                'https://mediterraneanbi.com:443/news',
                'https://mediterraneanbi.com:3000/news',
                'http://93.189.91.62:8080/news',
                'https://93.189.91.62:8443/news',
                'https://93.189.91.62/news',
                'https://93.189.91.62:443/news'
            ];
            
            let lastError = null;
            for (const url of urls) {
                try {
                    const r = await tryFetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
                        body: JSON.stringify(obj),
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    const d = await r.json();
                    const arr = loadNews();
                    arr.unshift(d);
                    saveNewsArray(arr);
                    return d; // Retorna el objeto guardado en el servidor
                } catch (e) {
                    lastError = e;
                    console.warn('‚ö†Ô∏è URL fall√≥:', url, e.message);
                    // Si es un error de CSP, mostrar mensaje espec√≠fico
                    if (e.message && e.message.includes('CSP')) {
                        console.error('Error de CSP al intentar:', url);
                    }
                }
            }
            
            // Si todas las URLs fallaron, mostrar el √∫ltimo error
            if (lastError && lastError.message && lastError.message.includes('CSP')) {
                console.error('Todas las URLs fallaron por CSP. Guardando localmente.');
            }
            
            // Fallback local - guardar en localStorage
            const arr = loadNews();
            // Generar un ID √∫nico si no existe
            if(!obj.id) {
                obj.id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            arr.unshift(obj);
            saveNewsArray(arr);
            return obj; // Retorna el objeto guardado localmente
        }
        
        async function updateNewsAt(index,obj){ 
            const items = loadNews();
            const id = items[index] && items[index].id;
            const urls = [
                `https://mediterraneanbi.com:443/news/${id}`,
                `https://mediterraneanbi.com:3000/news/${id}`,
                `http://93.189.91.62:8080/news/${id}`,
                `https://93.189.91.62:8443/news/${id}`,
                `https://93.189.91.62/news/${id}`,
                `https://93.189.91.62:443/news/${id}`
            ];
            
            for (const url of urls) {
                try {
                    const r = await tryFetch(url, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
                        body: JSON.stringify(obj)
                    });
                    const d = await r.json();
                    items[index] = d;
                    saveNewsArray(items);
                    return d;
                } catch (e) {
                    console.warn('‚ö†Ô∏è URL fall√≥:', url, e.message);
                }
            }
            
            // Fallback local
            items[index] = Object.assign({id}, obj);
            saveNewsArray(items);
            return items[index];
        }
        
        async function deleteNewsAt(index){ 
            const items = loadNews();
            const id = items[index] && items[index].id;
            const urls = [
                `https://mediterraneanbi.com:443/news/${id}`,
                `https://mediterraneanbi.com:3000/news/${id}`,
                `http://93.189.91.62:8080/news/${id}`,
                `https://93.189.91.62:8443/news/${id}`,
                `https://93.189.91.62/news/${id}`,
                `https://93.189.91.62:443/news/${id}`,
                `https://mediterraneanbi.com:8443/news/${id}`
            ];
            
            for (const url of urls) {
                try {
                    await tryFetch(url, {method: 'DELETE'});
                    items.splice(index, 1);
                    saveNewsArray(items);
                    return;
                } catch (e) {
                    console.warn('‚ö†Ô∏è URL fall√≥:', url, e.message);
                }
            }
            
            // Fallback local
            items.splice(index, 1);
            saveNewsArray(items);
        }

        function clearForm(){ 
            document.getElementById('newsTitle').value=''; 
            document.getElementById('newsLink').value=''; 
            document.getElementById('newsDesc').value=''; 
            document.getElementById('newsImageFile').value='';
            uploadedImageUrl = null;
            document.getElementById('imagePreview').style.display='none';
            linkInput.dataset.image = '';
            editingIndex=null; 
        }

        async function renderList(){
            const container = document.getElementById('newsList');
            container.innerHTML='';
            const items = await fetchAll();
            if(!items.length){ container.innerHTML = '<div style="text-align:center;color:#666;padding:16px">Sin noticias</div>'; return; }
            items.forEach((item, idx)=>{
                const el = document.createElement('div');
                el.className='item';
                el.innerHTML = `
                    <div style="flex:1 1 auto">
                        <div class="item-title">${item.title||'Untitled'}</div>
                        ${item.description?`<div style="margin-top:6px">${(item.description||'').replace(/\n/g,'<br>')}</div>`:''}
                        ${item.link?`<div style="margin-top:6px"><a href="${item.link}" target="_blank" rel="noopener">${item.link}</a></div>`:''}
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-secondary" data-action="edit">Editar</button>
                        <button class="btn btn-secondary" data-action="delete">Eliminar</button>
                    </div>`;
                el.querySelector('[data-action="edit"]').addEventListener('click', ()=>{
                    const items = loadNews();
                    const it = items[idx];
                    document.getElementById('newsTitle').value = it.title||'';
                    document.getElementById('newsLink').value = it.link||'';
                    document.getElementById('newsDesc').value = it.description||'';
                    // Cargar imagen si existe
                    if (it.image) {
                        uploadedImageUrl = it.image;
                        const previewImg = document.getElementById('imagePreviewImg');
                        previewImg.src = it.image;
                        document.getElementById('imagePreview').style.display = 'block';
                    } else {
                        uploadedImageUrl = null;
                        document.getElementById('imagePreview').style.display = 'none';
                    }
                    editingIndex = idx;
                });
                el.querySelector('[data-action="delete"]').addEventListener('click', async ()=>{
                    const confirmed = await showConfirm(
                        'Eliminar noticia', 
                        `¬øEst√°s seguro de que quieres eliminar la noticia "${item.title || 'Sin t√≠tulo'}"? Esta acci√≥n no se puede deshacer.`,
                        'üóëÔ∏è',
                        'Eliminar',
                        'Cancelar'
                    );
                    
                    if (confirmed) {
                        try {
                            await deleteNewsAt(idx);
                            showSuccess('Noticia eliminada', 'La noticia se ha eliminado correctamente de la base de datos');
                            renderList();
                        } catch (error) {
                            console.error('Error deleting news:', error);
                            showError('Error al eliminar', 'No se pudo eliminar la noticia. Int√©ntalo de nuevo.');
                        }
                    }
                });
                container.appendChild(el);
            });
        }

        async function fetchLinkMetadata(url){
            if(!url || !url.startsWith('http')) {
                showWarning('URL inv√°lida', 'Por favor, ingresa una URL v√°lida que comience con http:// o https://');
                return null;
            }

            // M√©todo 1: Intentar con Microlink API
            try{
                const endpoint = 'https://api.microlink.io/?url=' + encodeURIComponent(url);
                const res = await fetch(endpoint, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });
                if(!res.ok) throw new Error('HTTP '+res.status);
                const json = await res.json();
                if(json && json.status === 'success' && json.data){
                    const d = json.data;
                    const result = {
                        title: d.title || '',
                        description: d.description || '',
                        image: d.image && (d.image.url || d.image) ? (d.image.url || d.image) : '',
                        url: d.url || url
                    };
                    if(result.title || result.description) {
                        return result;
                    }
                }
            }catch(err){
                console.warn('Microlink API error:', err);
            }

            // M√©todo 2: Intentar con proxy CORS
            try{
                const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
                const res = await fetch(proxyUrl, {
                    method: 'GET',
                    mode: 'cors'
                });
                if(!res.ok) throw new Error('HTTP '+res.status);
                const json = await res.json();
                if(json && json.contents){
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(json.contents, 'text/html');
                    
                    // Extraer t√≠tulo
                    const title = doc.querySelector('meta[property="og:title"]')?.content ||
                                 doc.querySelector('meta[name="twitter:title"]')?.content ||
                                 doc.querySelector('title')?.textContent ||
                                 doc.querySelector('h1')?.textContent ||
                                 '';
                    
                    // Extraer descripci√≥n
                    const description = doc.querySelector('meta[property="og:description"]')?.content ||
                                      doc.querySelector('meta[name="twitter:description"]')?.content ||
                                      doc.querySelector('meta[name="description"]')?.content ||
                                      '';
                    
                    // Extraer imagen
                    const image = doc.querySelector('meta[property="og:image"]')?.content ||
                                 doc.querySelector('meta[name="twitter:image"]')?.content ||
                                 doc.querySelector('meta[name="twitter:image:src"]')?.content ||
                                 '';
                    
                    if(title || description) {
                        return {
                            title: title.trim(),
                            description: description.trim(),
                            image: image.trim(),
                            url: url
                        };
                    }
                }
            }catch(err){
                console.warn('CORS proxy error:', err);
            }

            // Si ambos m√©todos fallan, mostrar advertencia pero no error
            showWarning('No se pudo extraer informaci√≥n autom√°ticamente', 'Por favor, completa manualmente el t√≠tulo y la descripci√≥n.');
            return null;
        }

        const linkInput = document.getElementById('newsLink');
        linkInput.addEventListener('blur', async ()=>{
            const url = linkInput.value.trim();
            if(!url) return;
            
            // Mostrar indicador de carga
            const loadingMsg = showInfo('Extrayendo informaci√≥n...', 'Por favor espera mientras extraemos los datos de la noticia.');
            
            try {
                const meta = await fetchLinkMetadata(url);
                if(meta){
                    const titleEl = document.getElementById('newsTitle');
                    const descEl = document.getElementById('newsDesc');
                    if(!titleEl.value.trim() && meta.title) titleEl.value = meta.title;
                    if(!descEl.value.trim() && meta.description) descEl.value = meta.description;
                    linkInput.value = meta.url || url;
                    linkInput.dataset.image = meta.image || '';
                    const prevWrap = document.getElementById('linkPreview');
                    const prevImg = document.getElementById('linkPreviewImg');
                    if(meta.image){ 
                        prevImg.src = meta.image; 
                        prevWrap.style.display = 'block'; 
                    } else { 
                        prevImg.removeAttribute('src'); 
                        prevWrap.style.display = 'none'; 
                    }
                    if(loadingMsg) loadingMsg.remove();
                    if(meta.title || meta.description) {
                        showSuccess('Informaci√≥n extra√≠da', 'Los datos de la noticia se han extra√≠do correctamente.');
                    }
                } else {
                    if(loadingMsg) loadingMsg.remove();
                }
            } catch (error) {
                console.error('Error extracting metadata:', error);
                if(loadingMsg) loadingMsg.remove();
                showError('Error al extraer', 'No se pudo extraer la informaci√≥n de la URL. Por favor, completa los campos manualmente.');
            }
        });

        document.getElementById('saveNews').addEventListener('click', async ()=>{
            const title = document.getElementById('newsTitle').value.trim();
            const link = document.getElementById('newsLink').value.trim();
            const description = document.getElementById('newsDesc').value.trim();
            if(!title && !description && !link){ 
                showError('Error de validaci√≥n', 'Debe completar al menos el t√≠tulo o la descripci√≥n');
                return; 
            }
            
            try {
                // Mostrar indicador de carga
                const savingMsg = showInfo('Guardando noticia...', 'Por favor espera mientras guardamos la noticia.');
                
                // Usar imagen subida manualmente si existe, sino usar la extra√≠da
                let image = uploadedImageUrl || linkInput.dataset.image || '';
                
                // aseg√∫rate de tener metadata si solo hay link y no hay imagen subida
                if(link && (!title || !description || !image)){
                    try {
                        const meta = await fetchLinkMetadata(link);
                        if(meta){
                            if(!title) document.getElementById('newsTitle').value = meta.title || '';
                            if(!description) document.getElementById('newsDesc').value = meta.description || '';
                            // Solo usar imagen extra√≠da si no hay imagen subida manualmente
                            if(!image) image = meta.image || '';
                        }
                    } catch (metaError) {
                        console.warn('Error fetching metadata on save:', metaError);
                        // Continuar aunque falle la extracci√≥n de metadata
                    }
                }
                
                // Obtener valores finales
                const finalTitle = document.getElementById('newsTitle').value.trim();
                const finalDescription = document.getElementById('newsDesc').value.trim();
                
                if(!finalTitle && !finalDescription && !link){ 
                    if(savingMsg) savingMsg.remove();
                    showError('Error de validaci√≥n', 'Debe completar al menos el t√≠tulo o la descripci√≥n');
                    return; 
                }
                
                const obj = { 
                    title: finalTitle, 
                    link, 
                    description: finalDescription, 
                    image: image || null, 
                    date: Date.now() 
                };
                
                if(editingIndex!==null){ 
                    await updateNewsAt(editingIndex, obj); 
                    if(savingMsg) savingMsg.remove();
                    showSuccess('Noticia actualizada', 'La noticia se ha actualizado correctamente en la base de datos');
                } else { 
                    const result = await createNews(obj);
                    if(savingMsg) savingMsg.remove();
                    if(result) {
                        showSuccess('Noticia creada', 'La noticia se ha guardado correctamente en la base de datos');
                    } else {
                        showWarning('Guardado local', 'La noticia se ha guardado localmente. No se pudo conectar con el servidor.');
                    }
                }
                clearForm(); 
                renderList();
            } catch (error) {
                console.error('Error saving news:', error);
                showError('Error al guardar', 'No se pudo guardar la noticia: ' + (error.message || 'Error desconocido'));
            }
        });

        document.getElementById('clearForm').addEventListener('click', clearForm);
        
        // Event listeners para selecci√≥n y subida de imagen
        document.getElementById('selectImageBtn').addEventListener('click', () => {
            document.getElementById('newsImageFile').click();
        });
        
        document.getElementById('newsImageFile').addEventListener('change', async (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            
            // Validar que sea una imagen
            if (!file.type.startsWith('image/')) {
                showError('Error', 'Por favor selecciona un archivo de imagen v√°lido');
                return;
            }
            
            // Validar tama√±o (m√°ximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('Error', 'La imagen es demasiado grande. M√°ximo 10MB');
                return;
            }
            
            try {
                const loadingMsg = showInfo('Subiendo imagen...', 'Por favor espera mientras subimos la imagen.');
                const imageUrl = await uploadImageToCloudinary(file);
                uploadedImageUrl = imageUrl;
                
                // Mostrar preview
                const previewImg = document.getElementById('imagePreviewImg');
                previewImg.src = imageUrl;
                document.getElementById('imagePreview').style.display = 'block';
                
                if (loadingMsg) loadingMsg.remove();
                showSuccess('Imagen subida', 'La imagen se ha subido correctamente');
            } catch (error) {
                console.error('Error uploading image:', error);
                showError('Error al subir', 'No se pudo subir la imagen: ' + (error.message || 'Error desconocido'));
            }
        });
        
        document.getElementById('removeImageBtn').addEventListener('click', () => {
            uploadedImageUrl = null;
            document.getElementById('newsImageFile').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        });

        document.getElementById('exportBtn').addEventListener('click', ()=>{
            const dataStr = JSON.stringify(loadNews(), null, 2);
            const blob = new Blob([dataStr], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'news-backup.json'; a.click(); URL.revokeObjectURL(url);
        });

        document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
        document.getElementById('importFile').addEventListener('change', (e)=>{
            const file = e.target.files && e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev)=>{ try{ const arr = JSON.parse(ev.target.result); if(Array.isArray(arr)){ saveNewsArray(arr); renderList(); } }catch(_){} };
            reader.readAsText(file);
            e.target.value='';
        });

        // Custom Message System
        function showMessage(type, title, message, duration = 5000, customIcon = null) {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.custom-message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageEl = document.createElement('div');
            messageEl.className = `custom-message ${type}`;
            
            // Define icons for different message types
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è',
                // Specific action icons
                create: 'üìù',
                update: '‚úèÔ∏è',
                delete: 'üóëÔ∏è',
                save: 'üíæ',
                load: 'üì•',
                export: 'üì§',
                import: 'üì•'
            };
            
            const icon = customIcon || icons[type] || icons.info;
            
            messageEl.innerHTML = `
                <div class="message-icon">${icon}</div>
                <div class="message-content">
                    <div class="message-title">${title}</div>
                    <div class="message-text">${message}</div>
                </div>
                <button class="message-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            document.body.appendChild(messageEl);
            
            // Auto remove after duration
            setTimeout(() => {
                if (messageEl.parentElement) {
                    messageEl.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => messageEl.remove(), 300);
                }
            }, duration);
            
            return messageEl;
        }
        
        // Convenience functions for different message types
        function showSuccess(title, message, duration = 5000, customIcon = null) {
            return showMessage('success', title, message, duration, customIcon);
        }
        
        function showError(title, message, duration = 7000, customIcon = null) {
            return showMessage('error', title, message, duration, customIcon);
        }
        
        function showWarning(title, message, duration = 6000, customIcon = null) {
            return showMessage('warning', title, message, duration, customIcon);
        }
        
        function showInfo(title, message, duration = 5000, customIcon = null) {
            return showMessage('info', title, message, duration, customIcon);
        }

        // Custom Confirmation System
        function showConfirm(title, message, icon = '‚ùì', confirmText = 'Confirmar', cancelText = 'Cancelar') {
            return new Promise((resolve) => {
                // Create overlay
                const overlay = document.createElement('div');
                overlay.className = 'confirm-overlay';
                
                // Create dialog
                const dialog = document.createElement('div');
                dialog.className = 'confirm-dialog';
                
                dialog.innerHTML = `
                    <div class="confirm-header">
                        <div class="confirm-icon">${icon}</div>
                        <h3 class="confirm-title">${title}</h3>
                    </div>
                    <div class="confirm-message">${message}</div>
                    <div class="confirm-actions">
                        <button class="confirm-btn secondary" data-action="cancel">${cancelText}</button>
                        <button class="confirm-btn danger" data-action="confirm">${confirmText}</button>
                    </div>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // Handle button clicks
                const buttons = dialog.querySelectorAll('.confirm-btn');
                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        const action = button.getAttribute('data-action');
                        const result = action === 'confirm';
                        
                        // Animate out
                        overlay.style.animation = 'fadeIn 0.2s ease reverse';
                        setTimeout(() => {
                            overlay.remove();
                        }, 200);
                        
                        resolve(result);
                    });
                });
                
                // Handle overlay click (cancel)
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.style.animation = 'fadeIn 0.2s ease reverse';
                        setTimeout(() => {
                            overlay.remove();
                        }, 200);
                        resolve(false);
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', renderList);

        // Logo responsive: dividir en grupos de 2 palabras y centrar la √∫ltima en m√≥vil
        (function responsiveLogo(){
            function apply(){
                document.querySelectorAll('.logo-text .logo-main').forEach(function(el){
                    var isMobile = window.innerWidth <= 767;
                    var original = el.getAttribute('data-original');
                    if(!original){ original = (el.textContent||'').trim().replace(/\s+/g,' '); el.setAttribute('data-original', original); }
                    if(isMobile){
                        if(!el.querySelector('.logo-chunk')){
                            var words = original.split(' ');
                            var chunks=[]; for(var i=0;i<words.length;i+=2){ chunks.push(words.slice(i,i+2).join(' ')); }
                            el.innerHTML = chunks.map(function(c,i){ return '<span class="logo-chunk'+(i===chunks.length-1?' last':'')+'">'+c+'</span>'; }).join(' ');
                        }
                    } else {
                        el.textContent = original;
                    }
                });
            }
            apply();
            window.addEventListener('resize', apply);
        })();
    </script>
    
    <footer>
        ¬© 2023 Mediterranean Blue International LLC. All rights reserved.
        <div style="text-align:center; margin-top:6px;">
            <a href="https://xkmarasa.github.io/rxdev-presentation.html" target="_blank" rel="noopener noreferrer" style="color: var(--white); text-decoration: underline;">@https://www.RXDev.com/es</a>
        </div>
    </footer>
</body>
</html>


